<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wrapper {
            width: 500px;
            height: 500px;
        }
        
        #flip-card {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transform-style: preserve-3d;
        }

        #card-front,
        #card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        #card-front {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #card-back {
            transform: rotateY(180deg);
        }

        #profile {
            position: relative;
        }

        .nametag {
            color: #ffffff;
        }
        
        .nametag span:last-child {
            opacity: 0.3;
        }

        .titletag {
            font-size: 14px;
            color: #ffffff;
            max-width: 227px;
            word-wrap: break-word;
            opacity: 0.3;
            text-align: left;
        }

        svg {
            display: block;
            margin: 0 auto;
            position: relative;
        }

        text {
            font-family: 'Outfit', sans-serif;
        }

        .rotateY {
            animation: rotateY 10s 0s linear infinite;
        }

        @keyframes rotateY {
            0% {
                transform: rotateY(0deg);
            }

            80% {
                transform: rotateY(360deg);
            }

            100% {
                transform: rotateY(360deg);
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-svg@1.1.0/lib/qrcode.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <title>ProfileNFT</title>
</head>
<body>
    <div class="container">
        <div class="wrapper">
            <div id="flip-card">
                <div id="card-front">
                    <div id="profile"></div>
                </div>
                <div id="card-back"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        const urlParams = new URLSearchParams(window.location.search);
        const handleParam = urlParams.get("handle");
        const color = {
            black: "#000000",
            white: "#ffffff"
        };
        const width = 500;
        const height = 500;
        const qrSize = 100;
        const link3Url = "link3.to/";

        // TODO: update nodeURL, contractAddress and abi
        const nodeURL = "https://eth-rinkeby.alchemyapi.io/v2/aogLQdKfxyXg2wnlfUt1771XbWfUtCbj";
        const provider = new ethers.providers.JsonRpcProvider(nodeURL);
        const contractAddress = "0x000000000000000000000000000000000000DEAD";
        const abi = [
            {
                "inputs":[
                    {
                        "internalType":"string",
                        "name":"handle",
                        "type":"string"
                    }
                ],
                "name":"getProfileIdByHandle",
                "outputs":[
                    {
                        "internalType":"uint256",
                        "name":"",
                        "type":"uint256"
                    }
                ],
                "stateMutability":"view",
                "type":"function"
            },
            {
                "inputs":[
                    {
                        "internalType":"uint256",
                        "name":"profileId",
                        "type":"uint256"
                    }
                ],
                "name":"getAvatar",
                "outputs":[
                    {
                        "internalType":"string",
                        "name":"",
                        "type":"string"
                    }
                ],
                "stateMutability":"view",
                "type":"function"
            },
            {
                "inputs":[
                    {
                        "internalType":"uint256",
                        "name":"profileId",
                        "type":"uint256"
                    }
                ],
                "name":"getMetadata",
                "outputs":[
                    {
                        "internalType":"string",
                        "name":"","type":"string"
                    }
                ],
                "stateMutability":"view",
                "type":"function"
            }
        ];
        const contract = new ethers.Contract(
            contractAddress,
            abi,
            provider
        );

        const computeFontSize = (elemClass, maxFontSize, padding, maxElemWidth) => {
            const elem = document.getElementsByClassName(elemClass)[0];
            const bbox = elem?.getBBox();
            const textWidth = bbox ? (bbox.width + padding) : 0;
            const fontSize = maxFontSize * maxElemWidth / textWidth;
            return Math.min(fontSize, maxFontSize);
        }

        const getTextWidth = (text, fontSize, padding) => {
            const element = document.createElement('canvas');
            const context = element.getContext('2d');
            context.font = `${fontSize}px Arial`;
            const textWidth = context.measureText(text).width;
            const width = (textWidth ? textWidth + padding : 0) * 1.03;
            return width;
        }

        const render = (handle, imageURI, metadata) => {
            const svgFront = d3.select("#profile")
                .selectAll("svg")
                    .data([null])
                    .join("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .attr("viewbox", `0 0 ${width} ${height}`)
                        .style("overflow", "hidden");

            const backgroundFront = svgFront.selectAll(".backgroundFront")
            backgroundFront.data([null])
                .join("path")
                    .classed("backgroundFront", true)
                    .attr("d", () => { 
                        return "M393.98 76.0562C393.98 73.3842 393.337 70.7515 392.104 68.3808L369.742 25.3767C368.024 22.0729 364.609 20 360.886 20H269.622H113.655C109.979 20 107 22.9794 107 26.6546V450.186C107 453.713 108.862 456.979 111.898 458.776L143.84 477.68C146.406 479.199 149.332 480 152.314 480H264.215H387.325C391.001 480 393.98 477.021 393.98 473.345V76.0562Z";
                    })
                    .style("fill", color.black);

            if(imageURI) {
                svgFront.selectAll("defs").remove();
                svgFront.selectAll(".placeholderStroke").remove();
                svgFront.selectAll(".placeholderImage").remove();

                const defs = svgFront.append("defs");
                defs.append("pattern")
                        .attr("id", "pattern")
                        .attr("width", 1)
                        .attr("height", 1)
                            .append("image")
                                .attr("xlink:href", imageURI)
                                .attr("width", 65)
                                .attr("height", 60);

                const stroke = svgFront.selectAll(".stroke");
                stroke.data([null])
                    .join("path")
                        .classed("stroke", true)
                        .attr("d", () => { 
                            return "M65.248 39.8863L56.682 54.5586C55.3759 56.8213 53.4882 58.7001 51.2113 60.0037C48.9344 61.3072 46.3497 61.9889 43.7206 61.9793L26.6233 62C23.9871 61.9944 21.3988 61.3009 19.1184 59.9893C16.838 58.6776 14.9459 56.7939 13.6321 54.5275L5.02677 39.7468C3.70425 37.4854 3.00525 34.9187 3.00003 32.3046C2.99481 29.6904 3.68355 27.121 4.99703 24.8544L13.563 10.1813C14.8691 7.91864 16.7568 6.0398 19.0337 4.73624C21.3106 3.43267 23.8953 2.75099 26.5244 2.76065L43.6217 2.74072C46.2579 2.74584 48.8463 3.439 51.1268 4.75056C53.4072 6.06212 55.2993 7.94584 56.6129 10.2124L65.2142 24.9931C68.0382 29.5464 67.6911 35.8104 64.8897 40.5L65.248 39.8863Z";
                        })
                        .style("transform", "translate(130px, 50px)")
                        .style("fill", "url(#pattern)")
                        .style("stroke", color.white)
                        .style("stroke-width", 5);
            } else {
                const placeholderStroke = svgFront.selectAll(".placeholderStroke");
                placeholderStroke.data([null])
                    .join("circle")
                        .classed("placeholderStroke", true)
                        .attr("cx", 165)
                        .attr("cy", 82.5)
                        .attr("r", 32.5)
                        .style("fill", color.black)
                        .style("stroke", color.white)
                        .style("stroke-width", 5);

                const placeholderImage = svgFront.selectAll(".placeholderImage");
                placeholderImage.data([null])
                    .join("path")
                        .classed("placeholderImage", true)
                        .attr("d", () => { 
                            return "M11.3517 14.4352C15.0692 14.4352 18.0824 11.422 18.0824 7.70441C18.0824 3.98686 15.0692 0.973633 11.3517 0.973633C7.63412 0.973633 4.62089 3.98686 4.62089 7.70441C4.62089 11.422 7.63412 14.4352 11.3517 14.4352ZM11.3517 17.5762C5.1548 17.5762 0.130859 19.5557 0.130859 21.9952C0.130859 24.4348 5.1548 26.4171 11.3517 26.4171C17.5485 26.4171 22.5725 24.4376 22.5725 21.9981C22.5725 19.5585 17.5485 17.5762 11.3517 17.5762Z";
                        })
                        .style("transform", "translate(152.5px, 70px)")
                        .style("fill", color.white)
                        .style("opacity", 0.3);
            }

            if(handle) {
                // Animate card
                const card = d3.select("#flip-card")
                card.classed("rotateY", "true");

                // Generate QR Code
                const qrcode = new QRCode({
                    content: `https://link3.to/${handle}`,
                    padding: 0,
                    width: qrSize,
                    height: qrSize,
                    color: color.white,
                    background: color.black,
                    ecl: "M",
                });

                const qrCode = d3.select("#profile")
                .selectAll(".qrcode")
                .data([null])
                    .join("div")
                        .classed("qrcode", true)
                        .style("position", "absolute")
                        .style("left", "130px")
                        .style("bottom", "95px")
                        .html(qrcode.svg());

                const link = svgFront.selectAll(".link");
                link.data([null])
                    .join("text")
                        .classed("link", true)
                        .style("font-size", 18)
                        .style("fill", color.white)
                        .style("font-weight", 700)
                        .style("font-family", "Outfit")
                        .style("text-anchor", "start")
                        .style("alignment-baseline", "middle")
                        .style("transform", "translate(130px, 438px)")
                        .text(link3Url);

                const propHandle = svgFront.selectAll(".propHandle");
                propHandle.data([null])
                    .join("text")
                        .classed("propHandle", true)
                        .style("font-family", "Arial")
                        .style("font-size", 18)
                        .style("fill", "transparent")
                        .style("font-weight", 700)
                        .style("text-anchor", "start")
                        .style("alignment-baseline", "middle")
                        .style("transform", `translate(${width}px, ${height}px)`)
                        .text(handle);
                        
                const bgHandle = svgFront.selectAll(".bgHandle");
                bgHandle.data([null])
                    .join("rect")
                        .classed("bgHandle", true)
                        .attr("width", 0)
                        .attr("height", 25)
                        .attr("rx", 4)
                        .attr("x", 410)
                        .attr("y", 422)
                        .attr("transform", "skewX(-25)")
                        .style("fill", color.white);

                const handleFontSize = computeFontSize("propHandle", 18, 21, 158);

                const txtHandle = svgFront.selectAll(".txtHandle");
                txtHandle.data([null])
                    .join("text")
                        .classed("txtHandle", true)
                        .style("font-size", handleFontSize)
                        .style("fill", color.black)
                        .style("font-weight", 700)
                        .style("font-family", "Outfit")
                        .style("text-anchor", "start")
                        .style("alignment-baseline", "middle")
                        .style("transform", "translate(217.5px, 436px)")
                        .text(handle);

                svgFront.selectAll(".bgHandle")
                    .transition()
                    .duration(0)
                    .attr("width", getTextWidth(handle, handleFontSize, 21));
            }

            if(metadata) {               
                const name = metadata.name;
                const title = metadata.title;
                const organization = metadata.organization;
                const nameType = metadata.name_type;

                const propNametag = svgFront.selectAll(".propNametag");
                propNametag.data([null])
                    .join("text")
                        .classed("propNametag", true)
                        .style("font-size", 26)
                        .style("font-weight", 700)
                        .style("font-family", "Outfit")
                        .style("fill", "transparent")
                        .style("transform", `translate(${width}px, ${height}px)`)
                        .text(() => name ? name : "");
    
                const nametag = d3.select("#profile")
                    .selectAll(".nametag")
                    .data([null])
                        .join("div")
                        .classed("nametag", true)
                        .style("position", "absolute")
                        .style("left", "130px")
                        .style("top", "136px")
                        .html(() => {
                            if(!name) return;
                            const fontSize = computeFontSize("propNametag", 26, 0, 227);
                            const output = `<span style="font-size: ${fontSize}px">${nameType === "ENS" ? name.slice(0, -4) : name}</span><span style="font-size: ${fontSize}px">${nameType === "ENS" ? ".eth" : ""}</span>`;
                            return output;
                        });

                const titletag = d3.select("#profile")
                    .selectAll(".titletag")
                    .data([null])
                        .join("div")
                        .classed("titletag", true)
                            .style("position", "absolute")
                            .style("left", "130px")
                            .style("top", "181px")
                            .html(() => {
                                let output = "";
                                if(title) {
                                    output += title;
                                }
                                if(organization) {
                                    output += ` at ${organization}`;
                                }
                                return output;
                            });
            }

            // Render the back of the card
            const svgBack = d3.select("#card-back")
                .selectAll("svg")
                    .data([null])
                    .join("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .attr("viewbox", `0 0 ${width} ${height}`)
                        .style("overflow", "hidden");

            const backgroundBack = svgBack.selectAll(".backgroundBack")
            backgroundBack.data([null])
                .join("path")
                    .classed("backgroundBack", true)
                    .attr("d", () => { 
                        return "M107 76.0562C107 73.3842 107.644 70.7515 108.876 68.3808L131.238 25.3767C132.956 22.0729 136.371 20 140.095 20H231.358H387.325C391.001 20 393.98 22.9794 393.98 26.6546V450.186C393.98 453.713 392.118 456.979 389.082 458.776L357.14 477.68C354.574 479.199 351.648 480 348.666 480H236.765H113.655C109.979 480 107 477.021 107 473.345V76.0562Z";
                    })
                    .style("fill", color.black);

            const link3Logo = svgBack.selectAll(".link3Logo")
            link3Logo.data([null])
                .join("path")
                    .classed("link3Logo", true)
                    .attr("d", () => { 
                        return "M267.264 250.128L278.919 264.621C279.013 264.735 279.131 264.827 279.265 264.889C279.4 264.95 279.546 264.981 279.694 264.977H286.22C286.382 264.994 286.545 264.964 286.691 264.89C286.836 264.816 286.957 264.701 287.038 264.56C287.119 264.419 287.158 264.257 287.149 264.094C287.141 263.931 287.085 263.774 286.989 263.643L276.137 250.128C275.871 249.799 275.733 249.385 275.747 248.962C275.762 248.539 275.928 248.136 276.216 247.826L286.785 236.386C286.896 236.258 286.966 236.1 286.985 235.931C287.004 235.763 286.972 235.593 286.892 235.443C286.813 235.294 286.689 235.172 286.539 235.094C286.389 235.016 286.218 234.985 286.05 235.006H279.654C279.517 235.004 279.38 235.031 279.254 235.085C279.127 235.138 279.013 235.217 278.919 235.317L267.344 247.82C267.056 248.132 266.891 248.536 266.876 248.959C266.862 249.383 266.999 249.797 267.264 250.128ZM219.424 235.007H215.296C214.562 235.007 213.967 235.602 213.967 236.336V263.649C213.967 264.383 214.562 264.978 215.296 264.978H219.424C220.158 264.978 220.753 264.383 220.753 263.649V236.336C220.753 235.602 220.158 235.007 219.424 235.007ZM317.451 251.078V248.449C317.451 247.693 316.839 247.08 316.083 247.08H299.028C298.272 247.08 297.659 247.693 297.659 248.449V251.078C297.659 251.834 298.272 252.447 299.028 252.447H316.083C316.839 252.447 317.451 251.834 317.451 251.078ZM317.451 260.974V263.603C317.451 264.359 316.839 264.972 316.083 264.972H299.028C298.272 264.972 297.659 264.359 297.659 263.603V260.974C297.659 260.218 298.272 259.605 299.028 259.605H316.083C316.839 259.605 317.451 260.218 317.451 260.974ZM317.446 239.005V236.375C317.446 235.619 316.833 235.007 316.077 235.007H299.022C298.267 235.007 297.654 235.619 297.654 236.375V239.005C297.654 239.76 298.267 240.373 299.022 240.373H316.077C316.833 240.373 317.446 239.76 317.446 239.005ZM246.506 235.007C250.69 235.007 256.283 237.93 256.379 248.301V248.352V263.847C256.379 264.146 256.26 264.434 256.048 264.646C255.835 264.858 255.548 264.978 255.248 264.978H250.724C250.424 264.978 250.136 264.858 249.924 264.646C249.712 264.434 249.593 264.146 249.593 263.847V249.709C249.593 241.793 245.702 241.793 243.938 241.793H239.98C239.68 241.793 239.392 241.912 239.18 242.124C238.968 242.336 238.849 242.624 238.849 242.924V263.847C238.849 264.146 238.73 264.434 238.518 264.646C238.305 264.858 238.018 264.978 237.718 264.978H233.194C232.894 264.978 232.606 264.858 232.394 264.646C232.182 264.434 232.063 264.146 232.063 263.847V238.903C232.062 238.391 232.162 237.884 232.358 237.411C232.553 236.938 232.84 236.508 233.202 236.146C233.564 235.784 233.994 235.497 234.467 235.302C234.94 235.106 235.447 235.006 235.959 235.007H246.506ZM188.298 235.472C188 235.174 187.596 235.007 187.174 235.007H183.589C183.168 235.007 182.763 235.174 182.465 235.472C182.167 235.77 182 236.174 182 236.596V251.92C182 259.498 185.676 265 195.074 265H201.391C201.812 265 202.216 264.833 202.514 264.535C202.812 264.237 202.98 263.833 202.98 263.411V259.402C202.98 258.98 202.812 258.576 202.514 258.278C202.216 257.98 201.812 257.813 201.391 257.813H195.442C189.894 257.813 188.763 255.517 188.763 251.864V236.596C188.763 236.174 188.596 235.77 188.298 235.472Z";
                    })
                    .style("fill", color.white);
        }

        const getProfile = async () => {
            let profileId, handle, imageURI, metadata;

            try {
                // Step 1: Get profile id
                if(handleParam || handleParam === 0) {
                    profileId = await contract.getProfileIdByHandle(handleParam);
                    profileId = profileId?.toNumber();
                }

                if(profileId) {
                    handle = handleParam;

                    // Step 2: Get avatar image
                    imageURI = await contract.getAvatar(profileId);

                    // Step 3: Get metadata
                    const ipfsHash = await contract.getMetadata(profileId);
                    const data = await fetch(`https://cyberconnect.mypinata.cloud/ipfs/${ipfsHash}`);
                    if(data.status === 200) {
                        metadata = await data.json();
                    }
                }
            } catch (error) {
                console.error(error.message);
            }

            return { handle, imageURI, metadata };
        }

        const load = async () => {
            // Render to generate placeholder SVG
            render();

            // Render to generate profile SVG
            const { handle, imageURI, metadata } = await getProfile();
            render(handle, imageURI, metadata);
        }

        window.addEventListener("load", load);
    </script>
</body>
</html>
