// SPDX-License-Identifier: GPL-3.0-or-later

pragma solidity 0.8.14;

import "../../src/periphery/ProfileNFTDescriptor.sol";
import "forge-std/Test.sol";
import "../../src/libraries/Constants.sol";
import { RolesAuthority } from "../../src/dependencies/solmate/RolesAuthority.sol";
import { Authority } from "../../src/dependencies/solmate/Auth.sol";
import { ERC1967Proxy } from "openzeppelin-contracts/contracts/proxy/ERC1967/ERC1967Proxy.sol";
import { TestLib712 } from "../utils/TestLib712.sol";
import { MockProfile } from "../utils/MockProfile.sol";
import { DataTypes } from "../../src/libraries/DataTypes.sol";

contract ProfileNFTDescriptorTest is Test {
    ProfileNFTDescriptor internal descriptor;
    MockProfile internal profile;
    address constant alice = address(0xA11CE);
    address constant bob = address(0xB0B);
    address constant owner = address(0xe);
    string animationTemplate = "https://animation.example.com";

    function setUp() public {
        profile = new MockProfile(address(0), address(0));
        ProfileNFTDescriptor impl = new ProfileNFTDescriptor(address(profile));
        bytes memory data = abi.encodeWithSelector(
            ProfileNFTDescriptor.initialize.selector,
            animationTemplate
        );
        ERC1967Proxy proxy = new ERC1967Proxy(address(impl), data);
        descriptor = ProfileNFTDescriptor(address(proxy));
    }

    function testBasic() public {
        assertEq(descriptor.animationTemplate(), animationTemplate);
    }

    function testCannotSetAnimationTemplateNonProfile() public {
        vm.expectRevert("ONLY_PROFILE");
        vm.prank(address(0));
        descriptor.setAnimationTemplate(animationTemplate);
    }

    function testSetAnimationTemplateAsProfile() public {
        vm.prank(address(profile));
        descriptor.setAnimationTemplate("https://new.animation.example.com");
        assertEq(
            descriptor.animationTemplate(),
            "https://new.animation.example.com"
        );
    }

    function testTokenURI() public {
        DataTypes.ConstructTokenURIParams memory params = DataTypes
            .ConstructTokenURIParams({
                tokenId: 0,
                handle: "alice",
                subscribers: 10
            });
        string memory tokenURI = descriptor.tokenURI(params);
        assertEq(
            tokenURI,
            "data:application/json;base64,eyJuYW1lIjoiQGFsaWNlIiwiZGVzY3JpcHRpb24iOiJDeWJlckNvbm5lY3QgcHJvZmlsZSBmb3IgQGFsaWNlIiwiaW1hZ2UiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIzYVdSMGFEMG5OVEF3SnlCb1pXbG5hSFE5SnpVd01DY2dkbWxsZDBKdmVEMG5NQ0F3SURVd01DQTFNREFuSUdacGJHdzlKMjV2Ym1VbklIaHRiRzV6UFNkb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnljZ2VHMXNibk02ZUd4cGJtczlKMmgwZEhBNkx5OTNkM2N1ZHpNdWIzSm5MekU1T1RrdmVHeHBibXNuUGp4emRIbHNaVDVBWm05dWRDMW1ZV05sSUh0bWIyNTBMV1poYldsc2VUMG5JazkxZEdacGRDSXNJSE5oYm5NdGMyVnlhV1k3SjMwOEwzTjBlV3hsUGp4d1lYUm9JR1E5SjAwMU9TQXhNRFF1T0RJMlF6VTVJRGt5TGpBNE1EWWdOakl1TURRMU1pQTNPUzQxTVRrM0lEWTNMamc0TWlBMk9DNHhPRGswVERnMExqTXlPVGtnTXpZdU1qWXhNME00T1M0ME56UXhJREkyTGpJM05UUWdPVGt1TnpZMklESXdJREV4TUM0NU9Ua2dNakJJTVRjM0xqVTJPVWcwTWpFdU1qYzJRelF6TWk0ek1qSWdNakFnTkRReExqSTNOaUF5T0M0NU5UUXpJRFEwTVM0eU56WWdOREJXTkRJNExqVTJOa00wTkRFdU1qYzJJRFF6Tnk0NU9ERWdORE0yTGpnMU5pQTBORFl1T0RVZ05ESTVMak16T1NBME5USXVOVEU1VERRd05pNHlOaklnTkRZNUxqa3lNVU16T1RjdU5UZzRJRFEzTmk0ME5qSWdNemczTGpBeUlEUTRNQ0F6TnpZdU1UVTNJRFE0TUVneE9ESXVOekkwU0RjNVF6WTNMamsxTkRNZ05EZ3dJRFU1SURRM01TNHdORFlnTlRrZ05EWXdWakV3TkM0NE1qWmFKeUJtYVd4c1BTZGliR0ZqYXljdlBqeDBaWGgwSUhSbGVIUXRZVzVqYUc5eVBTZGxibVFuSUdSdmJXbHVZVzUwTFdKaGMyVnNhVzVsUFNkb1lXNW5hVzVuSnlCNFBTYzBNVEluSUhrOUp6VXdKeUJtYVd4c1BTY2pabVptSnlCbWIyNTBMWGRsYVdkb2REMG5OekF3SnlCbWIyNTBMV1poYldsc2VUMG5JazkxZEdacGRDSXNJSE5oYm5NdGMyVnlhV1luSUdadmJuUXRjMmw2WlQwbk16SW5QbUZzYVdObFBDOTBaWGgwUGp4cGJXRm5aU0I0UFNjeU1DNDJPU1VuSUhrOUp6UXlMamN5SlNjZ2FISmxaajBuWkdGMFlUcHBiV0ZuWlM5emRtY3JlRzFzTzJKaGMyVTJOQ3hRU0U0eVdubENNbHBZU25waFZ6bDFVRk5KZUV4cVJXbEpTR2gwWWtjMWVsQlRTbTlrU0ZKM1QyazRkbVF6WkROTWJtTjZURzA1ZVZwNU9IbE5SRUYzVEROT01scDVTV2RrTW14clpFZG5PVWxxUlhkTlExVnBTVWRvYkdGWFpHOWtSREJwVFZSQmQwcFRTV2RrYld4c1pEQktkbVZFTUdsTlEwRjNUR3BWWjAxcWEyZE5hbXRwVUdwNGQxbFlVbTlKUjFFNVNXc3dkMHhFUm5OT2VYZDNTVVV3ZUUxNWQzaGlSRVZ6VFVOQ1RrMVVWWE5OVjNjd1RFUkJaMVJVU1hsTVJFWnpUbmwzZDBsRk1IZE1SRXB6VFZOM2QwbEZNREpNUkVwelRWTjNkMGxGTURSTVJFcHpUVk4zZDBsRk1IaE5RM2Q1WWtSVmMwMURRazVOVkdOelRXMTNlRXhFUVdkVVZFbDNURVJLYzAxVGQzZEpSVEI1VFdsM2VXSkVSWE5OUTBKT1RXcG5jMDF0ZDNoTVJFRm5WRlJCYzAweWQzaE1SRUZuVkZSSmMwMHlkM3BNUkVGblZGUlpjMDB5ZDNoTVJFRm5WRlJGZUV4RVRuTk5VM2QzU1VVd2VFMTVkM3BpUkVWelRVTkNUazFVV1hOTk1uZDZURVJCWjFSVVNYZE1SRTV6VFZOM2QwbEZNSGxOYVhkNllrUkZjMDFEUWs1TmFsRnpUVEozZWt4RVFXZFVWRWswVEVST2MwMVRkM2RKUlRCM1RFUlNjMDFUZDNkSlJUQjVURVJTYzAxNWQzZEpSVEF5VEVSU2MwMVRkM2RKUlRBMFRFUlNjMDVUZDNkSlJUQjRUa04zTUdKRVJYTk5RMEpPVFdwSmMwNUhkM2hNUkVGblZGUkpNRXhFVW5OTmVYZDNTVVV3ZVU5RGR6QmlSRVZ6VFVOQ1RrMURkekZpUkVWelRVTkNUazFwZHpGaVJFMXpUVU5DVGs1cGR6RmlSRVZ6VFVOQ1RrMVVUWE5PVjNkNFRFUkJaMVJVUlRGTVJGWnpUbWwzZDBsRk1IbE5hWGN4WWtSRmMwMURRazVOYWxGelRsZDNla3hFUVdkVVZFazBURVJXYzAxVGQzZEpSVEIzVEVSYWMwMVRkM2RKUlRBeVRFUmFjMDFUZDNkSlJUQTBURVJhYzAxVGQzZEpSVEI0VFVOM01tSkVWWE5OUTBKT1RWUmpjMDV0ZDNoTVJFRm5WRlJKZDB4RVduTk5VM2QzU1VVd2VVMXBkekppUkVWelRVTkNUazFxWjNOT2JYZDRURVJCWjFSVVFYTk9NbmN6VEVSQloxUlVaM05PTW5kNFRFUkJaMVJVUlhkTVJHUnpUVk4zZDBsRk1IaE5hWGN6WWtSRmMwMURRazVOVkZGelRqSjNlRXhFUVdkVVZFVXlURVJrYzAxVGQzZEpSVEI0VDBOM00ySkVSWE5OUTBKT1RXcEJjMDR5ZDNoTVJFRm5WRlJKZVV4RVpITk9lWGQzU1VVd2VFMVRkelJpUkVWelRVTkNUazFVVFhOUFIzZDRURVJCWjFSVVJUSk1SR2h6VGtOM2QwbEZNSGRNUkd4elRsTjNkMGxGTURKTVJHeHpUbmwzZDBsRk1IaE9RM2MxWWtSRmMwMURRazVOYWtWelQxZDNlRXhFUVdkVVZFbDZURVJzYzAxVGQzZEpSVEI1VGxOM05XSkVSWE5OUTBKT1RXcGpjMDlYZDNoTVJFRm5WRlJCYzAxVVFuTk5VM2QzU1VVd2VreEVSWGRpUkVWelRVTkNUazU1ZDNoTlIzZDZURVJCWjFSVVJYcE1SRVYzWWtSRmMwMURRazVOVkZWelRWUkNjMDVwZDNkSlJUQjVUV2wzZUUxSGQzaE1SRUZuVkZSSk1FeEVSWGRpUkVWelRVTkNUazFxWjNOTlZFSnpUVk4zZDBsRk1IaE1SRVY0WWtSSmMwMURRazVPYVhkNFRWZDNlRXhFUVdkVVZHZHpUVlJHYzAxcGQzZEpSVEI0VFZOM2VFMVhkekJNUkVGblZGUkZNMHhFUlhoaVJFVnpUVU5DVGsxcVFYTk5WRVp6VFdsM2QwbEZNSGxOZVhkNFRWZDNlRXhFUVdkVVZFbHpUVlJLYzAxNWQzZEpSVEExVEVSRmVXSkVUWE5OUTBKT1RWUk5jMDFVU25OTlUzZDNTVVV3ZUU1cGQzaE5iWGQ2VEVSQloxUlVTWGxNUkVWNVlrUkZjMDFEUWs1TmFsVnpUVlJLYzAxVGQzZEpSVEI1VG5sM2VFMXRkM2hNUkVGblZGUkZjMDFVVG5OTmFYZDNTVVV3TUV4RVJYcGlSRTF6VFVOQ1RrOURkM2hOTW5kNVRFUkJaMVJVUlhoTVJFVjZZa1JKYzAxRFFrNU5WRkZ6VFZST2MwMVRkM2RKUlRCNFQxTjNlRTB5ZDNoTVJFRm5WRlJKZUV4RVJYcGlSRVZ6VFVOQ1RrMXFWWE5OVkU1elRXbDNkMGxGTUhkTVJFVXdZa1JGYzAxRFFrNU5hWGQ0VGtkM2VFeEVRV2RVVkd0elRWUlNjMDFwZDNkSlJUQjRUWGwzZUU1SGQzaE1SRUZuVkZSRk1VeEVSVEJpUkVWM1RFUkJaMVJVU1RSTVJFVXdZa1JGYzAxRFFrNU5RM2Q0VGxkM2VVeEVRV2RVVkZWelRWUldjMDFwZDNkSlJUQjRUVk4zZUU1WGR6Qk1SRUZuVkZSRk0weEVSVEZpUkVWelRVTkNUazFxU1hOTlZGWnpUVk4zZDBsRk1IbE9VM2Q0VGxkM2VVeEVRV2RVVkVselRWUmFjMDFwZDNkSlJUQTBURVJGTW1KRVNYTk5RMEpPVFZSRmMwMVVXbk5OVTNkM1NVVXdlRTE1ZDNoT2JYZDRURVJCWjFSVVJUSk1SRVV5WWtSTmMwMURRazVOYWtGelRWUmFjMDVEZDNkSlJUQjVUbmwzZUU1dGQzaE1SRUZuVkZSWmMwMVVaSE5OVTNkM1NVVXdORXhFUlROaVJGVnpUVU5DVGsxVVVYTk5WR1J6VFZOM2QwbEZNSGhQVTNkNFRqSjNlRXhFUVdkVVZFa3hURVJGTTJKRVNYTk5RMEpPVFZOM2VFOUhkM2hNUkVGblZGUlZjMDFVYUhOTlUzZDNTVVV3TTB4RVJUUmlSRWx6VFVOQ1RrMVVRWE5OVkdoelRWTjNkMGxGTUhoTmVYZDRUMGQzZUV4RVFXZFVWRVV4VEVSRk5HSkVXWE5OUTBKT1RXcEpjMDFVYUhOTmVYZDNTVVV3ZVU1cGQzaFBSM2Q0VEVSQloxUlVTVFJNUkVVMFlrUkZjMDFEUWs1TmFYZDRUMWQzZVV4RVFXZFVWRlZ6VFZSc2MwMTVkM2RKUlRCNFRWTjNlRTlYZHpCTVJFRm5WRlJGTTB4RVJUVmlSRVZ6VFVOQ1RrMXFRWE5OVkd4elRWTjNkMGxGTUhsTmVYZDRUMWQzZVV4RVFXZFVWRWt5VEVSRk5XSkVSWE5OUTBKT1RubDNlVTFIZDNoTVJFRm5WRlJGZUV4RVNYZGlSRVZ6VFVOQ1RrMVVUWE5OYWtKelRWTjNkMGxGTUhoT2FYZDVUVWQzZWt4RVFXZFVWRWw0VEVSSmQySkVSWE5OUTBKT1RXcGpjMDFxUW5OTlUzZDNTVVV3ZVV4RVNYaGlSRWx6VFVOQ1RrNVRkM2xOVjNkNVRFUkJaMVJVWjNOTmFrWnpUVk4zZDBsRk1IaE5RM2Q1VFZkM2VreEVRV2RVVkVVd1RFUkplR0pFUlhOTlEwSk9UV3BCYzAxcVJuTk9VM2QzU1VVd2VVNXBkM2xOVjNkNlRFUkJaMVJVWjNOTmFrcHpUWGwzZDBsRk1IaE5lWGQ1VFcxM2VFeEVRV2RVVkVVeFRFUkplV0pFVVhOTlEwSk9UV3BCYzAxcVNuTk5VM2QzU1VVd2VVNURkM2xOYlhjeFRFUkJaMVJVUVhOTmFrNXpUbmwzZDBsRk1EUk1SRWw2WWtSSmMwMURRazVOVkVWelRXcE9jMDVEZDNkSlJUQjRUbmwzZVUweWQzaE1SRUZuVkZSRk5VeEVTWHBpUkVselRVTkNUazFxU1hOTmFrNXpUVk4zZDBsRk1IbE9RM2Q1VFRKM2VreEVRV2RVVkVGelRXcFNjMDFUZDNkSlJUQXlURVJKTUdKRVJYTk5RMEpPVDFOM2VVNUhkM2hNUkVGblZGUkZlRXhFU1RCaVJFVnpUVU5DVGsxVVRYTk5hbEp6VFZOM2QwbEZNSGhPYVhkNVRrZDNNVXhFUVdkVVZFa3dURVJKTUdKRVJYTk5RMEpPVFdwamMwMXFVbk5OYVhkM1NVVXdkMHhFU1RGaVJFVnpUVU5DVGsxcGQzbE9WM2Q2VEVSQloxUlVXWE5OYWxaelRWTjNkMGxGTURSTVJFa3hZa1JGYzAxRFFrNU5WRUZ6VFdwV2MwMTVkM2RKUlRCNFRrTjNlVTVYZDNoTVJFRm5WRlJKZDB4RVNURmlSRlZ6VFVOQ1RrMXFXWE5OYWxaelRWTjNkMGxGTUhkTVJFa3lZa1JGYzAxRFFrNU5hWGQ1VG0xM2VreEVRV2RVVkZselRXcGFjMDFUZDNkSlJUQTBURVJKTW1KRVNYTk5RMEpPVFZSTmMwMXFXbk5OVTNkM1NVVXdlRTVUZDNsT2JYY3lURVJCWjFSVVNURk1SRWt5WWtSSmMwMURRazVOUTNkNVRqSjNlRXhFUVdkVVZFbHpUV3BrYzAxNWQzZEpSVEF5VEVSSk0ySkVSWE5OUTBKT1QwTjNlVTR5ZDNsTVJFRm5WRlJGZUV4RVNUTmlSRkZ6VFVOQ1RrMVVZM05OYW1SelRWTjNkMGxGTUhoUFUzZDVUakozTlV4RVFXZFVWRUZ6VFdwb2MwMVRkM2RKUlRBeVRFUkpOR0pFUlhOTlEwSk9UME4zZVU5SGQzaE1SRUZuVkZSRmVFeEVTVFJpUkVWelRVTkNUazFVVFhOTmFtaHpUVk4zZDBsRk1IaE9hWGQ1VDBkM2VreEVRV2RVVkVsM1RFUkpOR0pFUlhOTlEwSk9UV3BKYzAxcWFITk5VM2QzU1VVd2VVNURkM2xQUjNkNVRFUkJaMVJVU1ROTVJFazBZa1JGYzAxRFFrNU5RM2Q1VDFkM00weEVRV2RVVkdkelRXcHNjMDFwZDNkSlJUQjRUVk4zZVU5WGQzbE1SRUZuVkZSRk1FeEVTVFZpUkVWelRVTkNUazFxU1hOTmFteHpUV2wzZDBsRk1IbE9hWGQ1VDFkM2VFeEVRV2RKYVVKNlpFaEtkbUV5VlRsSmJtUnZZVmhTYkVscFFucGtTRXAyWVRKVmRHUXliR3RrUjJjNVNXcEZhVWxIV25CaVIzYzVTVzAxZG1KdFZXbE1lalE0VEROT01scDZORDBuSUhkcFpIUm9QU2N6TWk0ek1EVWxKeUJvWldsbmFIUTlKek15TGpNd05TVW5JRzl3WVdOcGRIazlKekF1TXljdlBqeG5JSE4wZVd4bFBTZDBjbUZ1YzJadmNtMDZkSEpoYm5Oc1lYUmxLREU1TGpZeU5pVXNJRGd6TGpnbEtTYytQSFJsZUhRZ1pHOXRhVzVoYm5RdFltRnpaV3hwYm1VOUoyaGhibWRwYm1jbklIZzlKekFuSUhrOUp6QW5JR1pwYkd3OUp5Tm1abVluSUdadmJuUXRjMmw2WlQwbk1qSndlQ2NnWm05dWRDMTNaV2xuYUhROUp6Y3dNQ2NnWm05dWRDMW1ZVzFwYkhrOUp5SlBkWFJtYVhRaUxDQnpZVzV6TFhObGNtbG1KejVzYVc1ck15NTBieTg4TDNSbGVIUStQSEpsWTNRZ2QybGtkR2c5SnpneWNIZ25JR2hsYVdkb2REMG5NalJ3ZUNjZ2NuZzlKelJ3ZUNjZ2NuazlKelJ3ZUNjZ1ptbHNiRDBuSTJabVppY2dkSEpoYm5ObWIzSnRQU2R6YTJWM1dDZ3RNalVwSnlCNFBTYzVOU2NnZVQwbkxUTW5MejQ4ZEdWNGRDQmtiMjFwYm1GdWRDMWlZWE5sYkdsdVpUMG5hR0Z1WjJsdVp5Y2dkR1Y0ZEMxaGJtTm9iM0k5SjNOMFlYSjBKeUI0UFNjeE1EQW5JSGs5SnkweEp5Qm1iMjUwTFhkbGFXZG9kRDBuTkRBd0p5Qm1iMjUwTFdaaGJXbHNlVDBuSWs5MWRHWnBkQ0lzSUhOaGJuTXRjMlZ5YVdZbklHWnZiblF0YzJsNlpUMG5Nakp3ZUNjZ1ptbHNiRDBuSXpBd01DYytZV3hwWTJVOEwzUmxlSFErUEM5blBqd3ZjM1puUGc9PSIsImFuaW1hdGlvbl91cmwiOiJodHRwczovL2FuaW1hdGlvbi5leGFtcGxlLmNvbT9oYW5kbGU9YWxpY2UiLCJhdHRyaWJ1dGVzIjpbeyJ0cmFpdF90eXBlIjoiaWQiLCJ2YWx1ZSI6IjAifSx7InRyYWl0X3R5cGUiOiJsZW5ndGgiLCJ2YWx1ZSI6IjUifSx7InRyYWl0X3R5cGUiOiJzdWJzY3JpYmVycyIsInZhbHVlIjoiMTAifSx7InRyYWl0X3R5cGUiOiJoYW5kbGUiLCJ2YWx1ZSI6IkBhbGljZSJ9XX0="
        );
    }
}
