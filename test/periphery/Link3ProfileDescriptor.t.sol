// SPDX-License-Identifier: GPL-3.0-or-later

pragma solidity 0.8.14;

import "forge-std/Test.sol";
import { ERC1967Proxy } from "openzeppelin-contracts/contracts/proxy/ERC1967/ERC1967Proxy.sol";

import { Link3ProfileDescriptor } from "../../src/periphery/Link3ProfileDescriptor.sol";
import { DataTypes } from "../../src/libraries/DataTypes.sol";

contract Link3ProfileDescriptorTest is Test {
    Link3ProfileDescriptor internal descriptor;
    address constant owner = address(0xA11CE);
    string animationTemplate = "https://animation.example.com";

    event Upgraded(address indexed implementation);
    event SetAnimationTemplate(string preTemplate, string template);

    function setUp() public {
        Link3ProfileDescriptor descriptorImpl = new Link3ProfileDescriptor();
        bytes memory data = abi.encodeWithSelector(
            Link3ProfileDescriptor.initialize.selector,
            animationTemplate,
            owner
        );
        ERC1967Proxy proxy = new ERC1967Proxy(address(descriptorImpl), data);
        descriptor = Link3ProfileDescriptor(address(proxy));
    }

    function testBasic() public {
        assertEq(descriptor.animationTemplate(), animationTemplate);
    }

    function testCannotSetAnimationTemplateNonProfile() public {
        vm.expectRevert("UNAUTHORIZED");
        vm.prank(address(0));
        descriptor.setAnimationTemplate(animationTemplate);
    }

    function testSetAnimationTemplateAsProfile() public {
        vm.prank(owner);

        string memory newTemplate = "https://new.animation.example.com";
        vm.expectEmit(false, false, false, true);
        emit SetAnimationTemplate(animationTemplate, newTemplate);

        descriptor.setAnimationTemplate(newTemplate);
        assertEq(descriptor.animationTemplate(), newTemplate);
    }

    function testCannotSetAnimationTemplateAsNonOwner() public {
        vm.expectRevert("UNAUTHORIZED");
        descriptor.setAnimationTemplate("new_ani_template");
    }

    function testTokenURI() public {
        DataTypes.ConstructTokenURIParams memory params = DataTypes
            .ConstructTokenURIParams({
                tokenId: 0,
                handle: "alice",
                subscribers: 10
            });
        string memory tokenURI = descriptor.tokenURI(params);
        assertEq(
            tokenURI,
            "data:application/json;base64,eyJuYW1lIjoiQGFsaWNlIiwiZGVzY3JpcHRpb24iOiJMaW5rMyBwcm9maWxlIGZvciBAYWxpY2UiLCJpbWFnZSI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwbk5UQXdKeUJvWldsbmFIUTlKelV3TUNjZ2RtbGxkMEp2ZUQwbk1DQXdJRFV3TUNBMU1EQW5JR1pwYkd3OUoyNXZibVVuSUhodGJHNXpQU2RvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeWNnZUcxc2JuTTZlR3hwYm1zOUoyaDBkSEE2THk5M2QzY3Vkek11YjNKbkx6RTVPVGt2ZUd4cGJtc25Qanh6ZEhsc1pUNUFabTl1ZEMxbVlXTmxJSHRtYjI1MExXWmhiV2xzZVQwbklrOTFkR1pwZENJc0lITmhibk10YzJWeWFXWTdKMzA4TDNOMGVXeGxQanh3WVhSb0lHUTlKMDAxT1NBeE1EUXVPREkyUXpVNUlEa3lMakE0TURZZ05qSXVNRFExTWlBM09TNDFNVGszSURZM0xqZzRNaUEyT0M0eE9EazBURGcwTGpNeU9Ua2dNell1TWpZeE0wTTRPUzQwTnpReElESTJMakkzTlRRZ09Ua3VOelkySURJd0lERXhNQzQ1T1RrZ01qQklNVGMzTGpVMk9VZzBNakV1TWpjMlF6UXpNaTR6TWpJZ01qQWdORFF4TGpJM05pQXlPQzQ1TlRReklEUTBNUzR5TnpZZ05EQldOREk0TGpVMk5rTTBOREV1TWpjMklEUXpOeTQ1T0RFZ05ETTJMamcxTmlBME5EWXVPRFVnTkRJNUxqTXpPU0EwTlRJdU5URTVURFF3Tmk0eU5qSWdORFk1TGpreU1VTXpPVGN1TlRnNElEUTNOaTQwTmpJZ016ZzNMakF5SURRNE1DQXpOell1TVRVM0lEUTRNRWd4T0RJdU56STBTRGM1UXpZM0xqazFORE1nTkRnd0lEVTVJRFEzTVM0d05EWWdOVGtnTkRZd1ZqRXdOQzQ0TWpaYUp5Qm1hV3hzUFNkaWJHRmpheWN2UGp4MFpYaDBJSFJsZUhRdFlXNWphRzl5UFNkbGJtUW5JR1J2YldsdVlXNTBMV0poYzJWc2FXNWxQU2RvWVc1bmFXNW5KeUI0UFNjME1USW5JSGs5SnpVd0p5Qm1hV3hzUFNjalptWm1KeUJtYjI1MExYZGxhV2RvZEQwbk56QXdKeUJtYjI1MExXWmhiV2xzZVQwbklrOTFkR1pwZENJc0lITmhibk10YzJWeWFXWW5JR1p2Ym5RdGMybDZaVDBuTXpJblBtRnNhV05sUEM5MFpYaDBQanhwYldGblpTQjRQU2N5TUM0Mk9TVW5JSGs5SnpReUxqY3lKU2NnYUhKbFpqMG5aR0YwWVRwcGJXRm5aUzl6ZG1jcmVHMXNPMkpoYzJVMk5DeFFTRTR5V25sQ01scFlTbnBoVnpsMVVGTkplRXhxUldsSlNHaDBZa2MxZWxCVFNtOWtTRkozVDJrNGRtUXpaRE5NYm1ONlRHMDVlVnA1T0hsTlJFRjNURE5PTWxwNVNXZGtNbXhyWkVkbk9VbHFSWGROUTFWcFNVZG9iR0ZYWkc5a1JEQnBUVlJCZDBwVFNXZGtiV3hzWkRCS2RtVkVNR2xOUTBGM1RHcFZaMDFxYTJkTmFtdHBVR3A0ZDFsWVVtOUpSMUU1U1dzd2QweEVSbk5PZVhkM1NVVXdlRTE1ZDNoaVJFVnpUVU5DVGsxVVZYTk5WM2N3VEVSQloxUlVTWGxNUkVaelRubDNkMGxGTUhkTVJFcHpUVk4zZDBsRk1ESk1SRXB6VFZOM2QwbEZNRFJNUkVwelRWTjNkMGxGTUhoTlEzZDVZa1JWYzAxRFFrNU5WR056VFcxM2VFeEVRV2RVVkVsM1RFUktjMDFUZDNkSlJUQjVUV2wzZVdKRVJYTk5RMEpPVFdwbmMwMXRkM2hNUkVGblZGUkJjMDB5ZDNoTVJFRm5WRlJKYzAweWQzcE1SRUZuVkZSWmMwMHlkM2hNUkVGblZGUkZlRXhFVG5OTlUzZDNTVVV3ZUUxNWQzcGlSRVZ6VFVOQ1RrMVVXWE5OTW5kNlRFUkJaMVJVU1hkTVJFNXpUVk4zZDBsRk1IbE5hWGQ2WWtSRmMwMURRazVOYWxGelRUSjNla3hFUVdkVVZFazBURVJPYzAxVGQzZEpSVEIzVEVSU2MwMVRkM2RKUlRCNVRFUlNjMDE1ZDNkSlJUQXlURVJTYzAxVGQzZEpSVEEwVEVSU2MwNVRkM2RKUlRCNFRrTjNNR0pFUlhOTlEwSk9UV3BKYzA1SGQzaE1SRUZuVkZSSk1FeEVVbk5OZVhkM1NVVXdlVTlEZHpCaVJFVnpUVU5DVGsxRGR6RmlSRVZ6VFVOQ1RrMXBkekZpUkUxelRVTkNUazVwZHpGaVJFVnpUVU5DVGsxVVRYTk9WM2Q0VEVSQloxUlVSVEZNUkZaelRtbDNkMGxGTUhsTmFYY3hZa1JGYzAxRFFrNU5hbEZ6VGxkM2VreEVRV2RVVkVrMFRFUldjMDFUZDNkSlJUQjNURVJhYzAxVGQzZEpSVEF5VEVSYWMwMVRkM2RKUlRBMFRFUmFjMDFUZDNkSlJUQjRUVU4zTW1KRVZYTk5RMEpPVFZSamMwNXRkM2hNUkVGblZGUkpkMHhFV25OTlUzZDNTVVV3ZVUxcGR6SmlSRVZ6VFVOQ1RrMXFaM05PYlhkNFRFUkJaMVJVUVhOT01uY3pURVJCWjFSVVozTk9NbmQ0VEVSQloxUlVSWGRNUkdSelRWTjNkMGxGTUhoTmFYY3pZa1JGYzAxRFFrNU5WRkZ6VGpKM2VFeEVRV2RVVkVVeVRFUmtjMDFUZDNkSlJUQjRUME4zTTJKRVJYTk5RMEpPVFdwQmMwNHlkM2hNUkVGblZGUkplVXhFWkhOT2VYZDNTVVV3ZUUxVGR6UmlSRVZ6VFVOQ1RrMVVUWE5QUjNkNFRFUkJaMVJVUlRKTVJHaHpUa04zZDBsRk1IZE1SR3h6VGxOM2QwbEZNREpNUkd4elRubDNkMGxGTUhoT1EzYzFZa1JGYzAxRFFrNU5ha1Z6VDFkM2VFeEVRV2RVVkVsNlRFUnNjMDFUZDNkSlJUQjVUbE4zTldKRVJYTk5RMEpPVFdwamMwOVhkM2hNUkVGblZGUkJjMDFVUW5OTlUzZDNTVVV3ZWt4RVJYZGlSRVZ6VFVOQ1RrNTVkM2hOUjNkNlRFUkJaMVJVUlhwTVJFVjNZa1JGYzAxRFFrNU5WRlZ6VFZSQ2MwNXBkM2RKUlRCNVRXbDNlRTFIZDNoTVJFRm5WRlJKTUV4RVJYZGlSRVZ6VFVOQ1RrMXFaM05OVkVKelRWTjNkMGxGTUhoTVJFVjRZa1JKYzAxRFFrNU9hWGQ0VFZkM2VFeEVRV2RVVkdkelRWUkdjMDFwZDNkSlJUQjRUVk4zZUUxWGR6Qk1SRUZuVkZSRk0weEVSWGhpUkVWelRVTkNUazFxUVhOTlZFWnpUV2wzZDBsRk1IbE5lWGQ0VFZkM2VFeEVRV2RVVkVselRWUktjMDE1ZDNkSlJUQTFURVJGZVdKRVRYTk5RMEpPVFZSTmMwMVVTbk5OVTNkM1NVVXdlRTVwZDNoTmJYZDZURVJCWjFSVVNYbE1SRVY1WWtSRmMwMURRazVOYWxWelRWUktjMDFUZDNkSlJUQjVUbmwzZUUxdGQzaE1SRUZuVkZSRmMwMVVUbk5OYVhkM1NVVXdNRXhFUlhwaVJFMXpUVU5DVGs5RGQzaE5NbmQ1VEVSQloxUlVSWGhNUkVWNllrUkpjMDFEUWs1TlZGRnpUVlJPYzAxVGQzZEpSVEI0VDFOM2VFMHlkM2hNUkVGblZGUkplRXhFUlhwaVJFVnpUVU5DVGsxcVZYTk5WRTV6VFdsM2QwbEZNSGRNUkVVd1lrUkZjMDFEUWs1TmFYZDRUa2QzZUV4RVFXZFVWR3R6VFZSU2MwMXBkM2RKUlRCNFRYbDNlRTVIZDNoTVJFRm5WRlJGTVV4RVJUQmlSRVYzVEVSQloxUlVTVFJNUkVVd1lrUkZjMDFEUWs1TlEzZDRUbGQzZVV4RVFXZFVWRlZ6VFZSV2MwMXBkM2RKUlRCNFRWTjNlRTVYZHpCTVJFRm5WRlJGTTB4RVJURmlSRVZ6VFVOQ1RrMXFTWE5OVkZaelRWTjNkMGxGTUhsT1UzZDRUbGQzZVV4RVFXZFVWRWx6VFZSYWMwMXBkM2RKUlRBMFRFUkZNbUpFU1hOTlEwSk9UVlJGYzAxVVduTk5VM2QzU1VVd2VFMTVkM2hPYlhkNFRFUkJaMVJVUlRKTVJFVXlZa1JOYzAxRFFrNU5ha0Z6VFZSYWMwNURkM2RKUlRCNVRubDNlRTV0ZDNoTVJFRm5WRlJaYzAxVVpITk5VM2QzU1VVd05FeEVSVE5pUkZWelRVTkNUazFVVVhOTlZHUnpUVk4zZDBsRk1IaFBVM2Q0VGpKM2VFeEVRV2RVVkVreFRFUkZNMkpFU1hOTlEwSk9UVk4zZUU5SGQzaE1SRUZuVkZSVmMwMVVhSE5OVTNkM1NVVXdNMHhFUlRSaVJFbHpUVU5DVGsxVVFYTk5WR2h6VFZOM2QwbEZNSGhOZVhkNFQwZDNlRXhFUVdkVVZFVXhURVJGTkdKRVdYTk5RMEpPVFdwSmMwMVVhSE5OZVhkM1NVVXdlVTVwZDNoUFIzZDRURVJCWjFSVVNUUk1SRVUwWWtSRmMwMURRazVOYVhkNFQxZDNlVXhFUVdkVVZGVnpUVlJzYzAxNWQzZEpSVEI0VFZOM2VFOVhkekJNUkVGblZGUkZNMHhFUlRWaVJFVnpUVU5DVGsxcVFYTk5WR3h6VFZOM2QwbEZNSGxOZVhkNFQxZDNlVXhFUVdkVVZFa3lURVJGTldKRVJYTk5RMEpPVG5sM2VVMUhkM2hNUkVGblZGUkZlRXhFU1hkaVJFVnpUVU5DVGsxVVRYTk5ha0p6VFZOM2QwbEZNSGhPYVhkNVRVZDNla3hFUVdkVVZFbDRURVJKZDJKRVJYTk5RMEpPVFdwamMwMXFRbk5OVTNkM1NVVXdlVXhFU1hoaVJFbHpUVU5DVGs1VGQzbE5WM2Q1VEVSQloxUlVaM05OYWtaelRWTjNkMGxGTUhoTlEzZDVUVmQzZWt4RVFXZFVWRVV3VEVSSmVHSkVSWE5OUTBKT1RXcEJjMDFxUm5OT1UzZDNTVVV3ZVU1cGQzbE5WM2Q2VEVSQloxUlVaM05OYWtwelRYbDNkMGxGTUhoTmVYZDVUVzEzZUV4RVFXZFVWRVV4VEVSSmVXSkVVWE5OUTBKT1RXcEJjMDFxU25OTlUzZDNTVVV3ZVU1RGQzbE5iWGN4VEVSQloxUlVRWE5OYWs1elRubDNkMGxGTURSTVJFbDZZa1JKYzAxRFFrNU5WRVZ6VFdwT2MwNURkM2RKUlRCNFRubDNlVTB5ZDNoTVJFRm5WRlJGTlV4RVNYcGlSRWx6VFVOQ1RrMXFTWE5OYWs1elRWTjNkMGxGTUhsT1EzZDVUVEozZWt4RVFXZFVWRUZ6VFdwU2MwMVRkM2RKUlRBeVRFUkpNR0pFUlhOTlEwSk9UMU4zZVU1SGQzaE1SRUZuVkZSRmVFeEVTVEJpUkVWelRVTkNUazFVVFhOTmFsSnpUVk4zZDBsRk1IaE9hWGQ1VGtkM01VeEVRV2RVVkVrd1RFUkpNR0pFUlhOTlEwSk9UV3BqYzAxcVVuTk5hWGQzU1VVd2QweEVTVEZpUkVWelRVTkNUazFwZDNsT1YzZDZURVJCWjFSVVdYTk5hbFp6VFZOM2QwbEZNRFJNUkVreFlrUkZjMDFEUWs1TlZFRnpUV3BXYzAxNWQzZEpSVEI0VGtOM2VVNVhkM2hNUkVGblZGUkpkMHhFU1RGaVJGVnpUVU5DVGsxcVdYTk5hbFp6VFZOM2QwbEZNSGRNUkVreVlrUkZjMDFEUWs1TmFYZDVUbTEzZWt4RVFXZFVWRmx6VFdwYWMwMVRkM2RKUlRBMFRFUkpNbUpFU1hOTlEwSk9UVlJOYzAxcVduTk5VM2QzU1VVd2VFNVRkM2xPYlhjeVRFUkJaMVJVU1RGTVJFa3lZa1JKYzAxRFFrNU5RM2Q1VGpKM2VFeEVRV2RVVkVselRXcGtjMDE1ZDNkSlJUQXlURVJKTTJKRVJYTk5RMEpPVDBOM2VVNHlkM2xNUkVGblZGUkZlRXhFU1ROaVJGRnpUVU5DVGsxVVkzTk5hbVJ6VFZOM2QwbEZNSGhQVTNkNVRqSjNOVXhFUVdkVVZFRnpUV3BvYzAxVGQzZEpSVEF5VEVSSk5HSkVSWE5OUTBKT1QwTjNlVTlIZDNoTVJFRm5WRlJGZUV4RVNUUmlSRVZ6VFVOQ1RrMVVUWE5OYW1oelRWTjNkMGxGTUhoT2FYZDVUMGQzZWt4RVFXZFVWRWwzVEVSSk5HSkVSWE5OUTBKT1RXcEpjMDFxYUhOTlUzZDNTVVV3ZVU1RGQzbFBSM2Q1VEVSQloxUlVTVE5NUkVrMFlrUkZjMDFEUWs1TlEzZDVUMWQzTTB4RVFXZFVWR2R6VFdwc2MwMXBkM2RKUlRCNFRWTjNlVTlYZDNsTVJFRm5WRlJGTUV4RVNUVmlSRVZ6VFVOQ1RrMXFTWE5OYW14elRXbDNkMGxGTUhsT2FYZDVUMWQzZUV4RVFXZEphVUo2WkVoS2RtRXlWVGxKYm1SdllWaFNiRWxwUW5wa1NFcDJZVEpWZEdReWJHdGtSMmM1U1dwRmFVbEhXbkJpUjNjNVNXMDFkbUp0VldsTWVqUTRURE5PTWxwNk5EMG5JSGRwWkhSb1BTY3pNaTR6TURVbEp5Qm9aV2xuYUhROUp6TXlMak13TlNVbklHOXdZV05wZEhrOUp6QXVNeWN2UGp4bklITjBlV3hsUFNkMGNtRnVjMlp2Y20wNmRISmhibk5zWVhSbEtERTVMall5TmlVc0lEZ3pMamdsS1NjK1BIUmxlSFFnWkc5dGFXNWhiblF0WW1GelpXeHBibVU5SjJoaGJtZHBibWNuSUhnOUp6QW5JSGs5SnpBbklHWnBiR3c5SnlObVptWW5JR1p2Ym5RdGMybDZaVDBuTWpKd2VDY2dabTl1ZEMxM1pXbG5hSFE5SnpRd01DY2dabTl1ZEMxbVlXMXBiSGs5SnlKUGRYUm1hWFFpTENCellXNXpMWE5sY21sbUp6NXNhVzVyTXk1MGJ5ODhMM1JsZUhRK1BISmxZM1FnZDJsa2RHZzlKemM0Y0hnbklHaGxhV2RvZEQwbk1qUndlQ2NnY25nOUp6UndlQ2NnY25rOUp6UndlQ2NnWm1sc2JEMG5JMlptWmljZ2RISmhibk5tYjNKdFBTZHphMlYzV0NndE1qVXBKeUI0UFNjNU1DY2dlVDBuTFRNbkx6NDhkR1Y0ZENCa2IyMXBibUZ1ZEMxaVlYTmxiR2x1WlQwbmFHRnVaMmx1WnljZ2RHVjRkQzFoYm1Ob2IzSTlKM04wWVhKMEp5QjRQU2M1TkNjZ2VUMG5NQ2NnWm05dWRDMTNaV2xuYUhROUp6UXdNQ2NnWm05dWRDMW1ZVzFwYkhrOUp5SlBkWFJtYVhRaUxDQnpZVzV6TFhObGNtbG1KeUJtYjI1MExYTnBlbVU5SnpJeWNIZ25JR1pwYkd3OUp5TXdNREFuUG1Gc2FXTmxQQzkwWlhoMFBqd3ZaejQ4TDNOMlp6ND0iLCJhbmltYXRpb25fdXJsIjoiaHR0cHM6Ly9hbmltYXRpb24uZXhhbXBsZS5jb20/aGFuZGxlPWFsaWNlIiwiYXR0cmlidXRlcyI6W3sidHJhaXRfdHlwZSI6ImlkIiwidmFsdWUiOiIwIn0seyJ0cmFpdF90eXBlIjoibGVuZ3RoIiwidmFsdWUiOiI1In0seyJ0cmFpdF90eXBlIjoic3Vic2NyaWJlcnMiLCJ2YWx1ZSI6IjEwIn0seyJ0cmFpdF90eXBlIjoiaGFuZGxlIiwidmFsdWUiOiJAYWxpY2UifV19"
        );
    }

    function testCannotUpgrade() public {
        vm.expectRevert("UNAUTHORIZED");
        descriptor.upgradeTo(address(0xDEAD));
    }

    function testUpgradeAsOwner() public {
        Link3ProfileDescriptor newAddr = new Link3ProfileDescriptor();
        vm.expectEmit(true, false, false, true);
        emit Upgraded(address(newAddr));
        vm.prank(owner);
        descriptor.upgradeTo(address(newAddr));
    }
}
